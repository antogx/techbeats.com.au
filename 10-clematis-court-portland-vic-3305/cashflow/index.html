<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cashflow and Capital Growth Calculator</title>
  <style>
    :root{
      --bg: #fbf7ef;
      --text: #1f2937;
      --muted: #6b7280;

      --blue: #1f6feb;
      --green:#1f9d55;
      --brown:#7a4b2a;
      --gold:#c9a227;
      --grey:#8a9099;

      --border: rgba(201,162,39,.95);
      --border2: rgba(201,162,39,.55);

      --shadow: 0 14px 34px rgba(31,41,55,.12);
      --shadow2: 0 8px 18px rgba(31,41,55,.10);

      --radius: 18px;
      --radius2: 12px;

      --focus: rgba(31,111,235,.28);

      --danger: #b42318;
      --ok: #067647;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    [data-theme="dark"]{
      --bg: #0b1220;
      --text: #f2f4f7;
      --muted: #a6b0c3;

      --blue: #79c0ff;
      --green:#7ee787;
      --brown:#d2a07a;
      --gold:#ffd36a;
      --grey:#cbd5e1;

      --border: rgba(255,211,106,.95);
      --border2: rgba(255,211,106,.55);

      --shadow: 0 14px 34px rgba(0,0,0,.35);
      --shadow2: 0 8px 18px rgba(0,0,0,.28);

      --focus: rgba(121,192,255,.25);
      --danger: #ff8b8b;
      --ok: #8ef0b0;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      font-size: 18px;
      color: var(--text);
      -webkit-text-size-adjust: 100%;
      overflow-x: hidden;

      background:
        radial-gradient(900px 520px at 12% 8%, rgba(31,111,235,.22), transparent 60%),
        radial-gradient(900px 520px at 88% 10%, rgba(31,157,85,.18), transparent 60%),
        radial-gradient(900px 620px at 88% 92%, rgba(122,75,42,.18), transparent 62%),
        radial-gradient(900px 520px at 12% 92%, rgba(201,162,39,.10), transparent 62%),
        var(--bg);
    }

    header{
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(10px);
      background: rgba(251,247,239,.78);
      border-bottom: 2px solid var(--border2);
    }
    [data-theme="dark"] header{ background: rgba(11,18,32,.78); }

    .header-inner{
      max-width: 1250px;
      margin: 0 auto;
      padding: 14px 14px;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    h1{
      margin:0;
      font-size: clamp(24px, 2.8vw, 36px);
      line-height: 1.1;
      letter-spacing: .2px;
    }

    .header-right{
      display:flex;
      align-items:center;
      gap: 12px;
      justify-content:flex-end;
    }

    .icon-btn{
      appearance:none;
      border: 2px solid var(--border);
      background: rgba(255,250,240,.88);
      color: var(--text);
      border-radius: 999px;
      padding: 11px 14px;
      display:flex;
      align-items:center;
      gap: 10px;
      cursor:pointer;
      box-shadow: var(--shadow2);
      touch-action: manipulation;
      user-select:none;
      min-height: 50px;
      font-weight: 900;
      font-size: 16px;
    }
    [data-theme="dark"] .icon-btn{ background: rgba(15,26,46,.88); }
    .icon-btn:active{transform: translateY(1px)}
    .icon{width: 18px; height: 18px; display:inline-block}
    .icon svg{width:100%; height:100%}

    .logo-preview{
      width: 150px;
      height: 150px;
      border-radius: 18px;
      border: 3px solid var(--border);
      background: rgba(255,250,240,.90);
      overflow:hidden;
      box-shadow: var(--shadow2);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }
    [data-theme="dark"] .logo-preview{ background: rgba(15,26,46,.90); }
    .logo-preview img{width:100%; height:100%; object-fit:contain; display:block;}

    .container{
      max-width: 1250px;
      margin: 0 auto;
      padding: 18px 14px 44px;
    }

    .stack{display:flex; flex-direction:column; gap: 14px; margin-top: 16px;}
    .two-col{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .card{
      border-radius: 18px;
      border: 3px solid var(--border);
      box-shadow: var(--shadow);
      padding: 16px;
      min-width: 0;
      background: rgba(255,250,240,.92);
    }
    [data-theme="dark"] .card{ background: rgba(15,26,46,.92); }

    .tint-details{
      border-width: 4px;
      box-shadow: 0 16px 44px rgba(31,111,235,.18), var(--shadow);
      background:
        linear-gradient(180deg, rgba(31,111,235,.10), transparent 55%),
        rgba(255,250,240,.92);
    }
    [data-theme="dark"] .tint-details{
      background:
        linear-gradient(180deg, rgba(121,192,255,.14), transparent 55%),
        rgba(15,26,46,.92);
    }

    .tint-inputs{
      background:
        linear-gradient(180deg, rgba(31,157,85,.10), transparent 55%),
        rgba(255,250,240,.92);
    }
    [data-theme="dark"] .tint-inputs{
      background:
        linear-gradient(180deg, rgba(126,231,135,.12), transparent 55%),
        rgba(15,26,46,.92);
    }

    .tint-summary{
      background:
        linear-gradient(180deg, rgba(122,75,42,.10), transparent 55%),
        rgba(255,250,240,.92);
    }
    [data-theme="dark"] .tint-summary{
      background:
        linear-gradient(180deg, rgba(210,160,122,.12), transparent 55%),
        rgba(15,26,46,.92);
    }

    .tint-forecast{
      background:
        linear-gradient(180deg, rgba(201,162,39,.12), transparent 60%),
        rgba(255,250,240,.92);
    }
    [data-theme="dark"] .tint-forecast{
      background:
        linear-gradient(180deg, rgba(255,211,106,.10), transparent 60%),
        rgba(15,26,46,.92);
    }

    .card h2{
      margin:0 0 10px;
      font-size: 20px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .pill{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 2px solid var(--border);
      background: rgba(255,250,240,.75);
    }
    [data-theme="dark"] .pill{ background: rgba(15,26,46,.75); }

    .form-grid{display:grid; grid-template-columns: 1fr 1fr; gap: 12px;}
    label{display:block; font-size: 14px; color: var(--muted); margin-bottom: 7px;}
    .field{display:flex; flex-direction: column; gap: 4px; min-width: 0;}

    input, select{
      width:100%;
      padding: 13px 13px;
      border-radius: 13px;
      border: 3px solid var(--border);
      background: rgba(255,250,240,.88);
      color: var(--text);
      outline:none;
      font-size: 18px;
      min-height: 52px;
      min-width: 0;
    }
    [data-theme="dark"] input, [data-theme="dark"] select{ background: rgba(15,26,46,.88); }
    input:focus, select:focus{box-shadow: 0 0 0 4px var(--focus);}
    input[disabled]{opacity: .98; cursor: not-allowed;}

    .static-strong input[disabled]{
      font-weight: 950;
      letter-spacing: .3px;
    }

    /* Summary spacing tighter */
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 6px 8px;               /* tighter */
      margin-top: 6px;
      font-size: 16px;
      min-width: 0;
    }
    .kv .k{color: var(--muted); min-width:0;}
    .kv .v{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space: nowrap;        /* keep on one line where possible */
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: right;
      min-width: 0;
      font-size: 16px;
    }

    .tint-summary .kv{ font-size: 18px; }
    .tint-summary .kv .k{
      color:#000;
      opacity:.78;
      font-weight:600;
    }
    .tint-summary .kv .v{
      font-size: 18px;
      color:#000;
      font-weight:650;
    }
    [data-theme="dark"] .tint-summary .kv .k,
    [data-theme="dark"] .tint-summary .kv .v{
      color: var(--text);
      opacity: 1;
    }

    .kv .v.good{color: var(--ok); font-weight: 950}
    .kv .v.bad{color: var(--danger); font-weight: 950}
    .divider{height:1px; background: var(--border2); margin: 12px 0;}

    .tag{
      display:inline-flex; gap: 8px; align-items:center;
      padding: 5px 10px;
      border-radius: 999px;
      border: 2px solid var(--border2);
      background: rgba(255,250,240,.70);
      color: var(--muted);
      font-size: 12px;
    }
    [data-theme="dark"] .tag{ background: rgba(15,26,46,.70); }

    .row{display:flex; align-items:center; justify-content: space-between; gap: 10px; flex-wrap: wrap;}

    .btn{
      appearance:none;
      border: 3px solid var(--border);
      background: rgba(255,250,240,.86);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 16px;
      cursor:pointer;
      font-weight: 950;
      box-shadow: var(--shadow2);
      min-height: 52px;
      touch-action: manipulation;
      user-select:none;
      font-size: 18px;
    }
    [data-theme="dark"] .btn{ background: rgba(15,26,46,.86); }
    .btn:active{transform: translateY(1px)}

    .btn.secondary{
      border-color: rgba(201,162,39,.55);
      font-weight: 850;
    }

    .save-note{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.35;
    }

    .error-box{
      display:none;
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 3px solid rgba(180,35,24,.9);
      background: rgba(180,35,24,.10);
      color: var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }
    .error-box.show{display:block;}

    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 12px;
      border: 3px solid var(--border);
      background: rgba(255,250,240,.88);
      box-shadow: var(--shadow2);
    }
    [data-theme="dark"] table{ background: rgba(15,26,46,.88); }

    th, td{
      padding: 10px 10px;          /* tighter columns */
      text-align:left;
      font-size: 14px;
      border-bottom: 1px solid var(--border2);
      vertical-align: middle;
    }
    th{
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,250,240,.65);
      position: sticky;
      top: 0;
      z-index: 1;
      white-space: nowrap;
    }
    [data-theme="dark"] th{ background: rgba(15,26,46,.65); }

    tr:last-child td{border-bottom:none;}
    td.num{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; white-space: nowrap;}
    .table-wrap{overflow:auto; border-radius: 12px;}

    tr.keyyear td{
      background: rgba(31,111,235,.10);
      border-bottom-color: rgba(31,111,235,.22);
      font-weight: 800;
    }
    [data-theme="dark"] tr.keyyear td{
      background: rgba(121,192,255,.12);
      border-bottom-color: rgba(121,192,255,.22);
    }

    @media (max-width: 980px){
      .two-col{grid-template-columns: 1fr;}
      .form-grid{grid-template-columns: 1fr;}
    }
    @media (max-width: 560px){
      input, select{font-size: 18px; min-height: 54px;}
      .logo-preview{width: 125px; height: 125px;}
      .kv{grid-template-columns: 1fr auto;} /* keep two cols but tighter */
      .kv .v{text-align: right;}
      th, td{padding: 8px 8px; font-size: 13px;}
      th{font-size: 11px;}
    }
  </style>
</head>

<body data-theme="light">
  <header>
    <div class="header-inner">
      <div>
        <h1>Cashflow and Capital growth calculator</h1>
      </div>

      <div class="header-right">
        <button class="icon-btn" id="themeToggle" type="button" aria-label="Toggle theme">
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="4"></circle>
              <path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M19.1 4.9l-1.4 1.4M6.3 17.7l-1.4 1.4"></path>
            </svg>
          </span>
        </button>

        
      </div>
    </div>
  </header>

  <main class="container">
    <div class="stack">

      <section class="card tint-details static-strong">
        <div class="row">
          <h2><span style="color:var(--blue)">■</span> Property details </h2>
        </div>

        <div class="form-grid">
          <div class="field">
            <label for="address">Address</label>
            <input id="address" type="text" value="10 Clematis Court, Portland, Vic 3305" />
          </div>
          <div class="field">
            <label for="purchasePrice">Purchase Price</label>
            <input id="purchasePrice" type="text" value="$637,500" inputmode="decimal" />
          </div>
        </div>

        <div class="save-note" id="templateNote" style="display:none;">
          Template mode: Address and Price are editable. Saved values persist only in this browser (localStorage).
        </div>
      </section>

      <section class="two-col">
        <div class="card tint-inputs">
          <h2><span style="color:var(--green)">■</span> Inputs</h2>

          <div class="form-grid">
            <div class="field">
              <label for="state">State (auto from Address, editable)</label>
              <input id="state" type="text" placeholder="e.g. NSW" />
            </div>

            <div class="field">
              <label for="lvr">LVR</label>
              <input id="lvr" type="text" inputmode="decimal" />
            </div>

            <div class="field">
              <label for="lmi">LMI</label>
              <input id="lmi" type="text" inputmode="decimal" />
              <div style="margin-top:6px;">
                <label style="display:flex;align-items:center;gap:10px;margin:0;color:var(--muted);font-size:14px;">
                  <input id="lmiAuto" type="checkbox" checked style="width:auto;min-height:auto;accent-color:var(--gold);" />
                  Auto-calculate LMI (turn off to override)
                </label>
                <span class="tag" id="lmiModeTag" style="margin-top:8px;display:inline-flex;">Auto</span>
              </div>
            </div>

            <div class="field">
              <label for="stampDuty">Stamp duty (Transfer duty)</label>
              <input id="stampDuty" type="text" inputmode="decimal" />
              <div style="margin-top:6px;">
                <label style="display:flex;align-items:center;gap:10px;margin:0;color:var(--muted);font-size:14px;">
                  <input id="dutyAuto" type="checkbox" checked style="width:auto;min-height:auto;accent-color:var(--gold);" />
                  Turn off to override
                </label>
                <span class="tag" id="dutyModeTag" style="margin-top:8px;display:inline-flex;">Auto</span>
              </div>
            </div>

            <div class="field">
              <label for="interest">Interest</label>
              <input id="interest" type="text" inputmode="decimal" />
            </div>

            <div class="field">
              <label for="rentWeek">Rent/week</label>
              <input id="rentWeek" type="text" inputmode="decimal" />
            </div>

            <div class="field">
              <label for="councilRates">Council Rates</label>
              <input id="councilRates" type="text" inputmode="decimal" />
            </div>

            <div class="field">
              <label for="insurance">Insurance</label>
              <input id="insurance" type="text" inputmode="decimal" />
            </div>

            <div class="field">
              <label for="pmFeePct">Property Management fees %</label>
              <input id="pmFeePct" type="text" inputmode="decimal" />
            </div>

            <div class="field">
              <label for="pmFee">Property Management fees</label>
              <input id="pmFee" type="text" inputmode="decimal" placeholder="auto = Rental income (Yr) × %"/>
              <div style="margin-top:6px;">
                <label style="display:flex;align-items:center;gap:10px;margin:0;color:var(--muted);font-size:14px;">
                  <input id="pmUseFormula" type="checkbox" checked style="width:auto;min-height:auto;accent-color:var(--gold);" />
                  Auto-calculate from % (turn off to override)
                </label>
                <span class="tag" id="pmModeTag" style="margin-top:8px;display:inline-flex;">Auto</span>
              </div>
            </div>

            <div class="field">
              <label for="maintenance">Maintenance</label>
              <input id="maintenance" type="text" inputmode="decimal" />
            </div>

            <div class="field">
              <label for="landTax">Land Tax</label>
              <input id="landTax" type="text" inputmode="decimal" />
            </div>

            <div class="field">
              <label for="depreciation">Depreciation (forced negative)</label>
              <input id="depreciation" type="text" inputmode="decimal" />
            </div>

            <div class="field">
              <label for="taxRate">Tax rate</label>
              <input id="taxRate" type="text" inputmode="decimal" />
            </div>

            <div class="field">
              <label for="capGrowth">Capital Growth Rate</label>
              <input id="capGrowth" type="text" inputmode="decimal" />
            </div>

            <div class="field">
              <label for="rentGrowth">Rent Growth Rate</label>
              <input id="rentGrowth" type="text" inputmode="decimal" />
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="recalcBtn" type="button">Recalculate</button>
            <button class="btn secondary" id="saveBtn" type="button">Save</button>
            <button class="btn secondary" id="resetBtn" type="button">Reset</button>
          </div>

          <div class="save-note" id="saveStatus"></div>

          <div id="errorBox" class="error-box"></div>
        </div>

        <div class="card tint-summary">
          <h2><span style="color:var(--brown)">■</span> Summary</h2>

          <div class="kv" id="summaryKv">
            <div class="k">Status</div><div class="v">Loading…</div>
          </div>
          <div class="divider"></div>
          <div class="kv" id="yieldKv">
            <div class="k">Status</div><div class="v">Loading…</div>
          </div>
          <div class="divider"></div>
          <div class="kv" id="cashflowKv">
            <div class="k">Status</div><div class="v">Loading…</div>
          </div>
        </div>
      </section>

      <section class="card tint-forecast">
        <div class="row">
          <h2><span style="color:var(--gold)">■</span> Forecast <span class="pill">Compounding</span></h2>

          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <select id="forecastMode" aria-label="Forecast Mode" style="max-width: 280px;">
              <option value="key">Key years (1, 5, 10, 15, 20)</option>
              <option value="all">All years (1–20)</option>
            </select>
          </div>
        </div>

        <div class="table-wrap" style="margin-top:12px;">
          <table>
            <thead>
              <tr>
                <th title="Year: forecast year number">Yr</th>
                <th title="Rent per year (gross): weekly rent × 52">Rent/yr</th>
                <th title="Cashflow After Tax per year">Cashflow after Tax/yr</th>
                <th title="Property Value at start of year (Year 1 = purchase price)">Value</th>
                <th title="Capital Growth dollars for the year (Value × growth rate)">Cap$/yr</th>
                <th title="Accumulated Capital Growth dollars from Year 1 to this year">Acc Cap$</th>
              </tr>
            </thead>
            <tbody id="forecastBody">
              <tr><td class="num">…</td><td colspan="5">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

    </div>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);
    const STATE_MAP = new Map([["NEW SOUTH WALES","NSW"],["NSW","NSW"],["VICTORIA","VIC"],["VIC","VIC"],["QUEENSLAND","QLD"],["QLD","QLD"],["SOUTH AUSTRALIA","SA"],["SA","SA"],["WESTERN AUSTRALIA","WA"],["WA","WA"],["TASMANIA","TAS"],["TAS","TAS"],["NORTHERN TERRITORY","NT"],["NT","NT"],["AUSTRALIAN CAPITAL TERRITORY","ACT"],["ACT","ACT"]]);
    const DUTY_PURPOSE = "investment"; // investment/home
    const IS_TEMPLATE = false;

    const DEFAULTS = {
      address: "10 Clematis Court, Portland, Vic 3305",
      purchase: 637500,
      state: "VIC",
      lvr: 0.8,
      interest: 0.06,
      rentWeek: 625,
      council: 2500,
      insurance: 800,
      pmPct: 7,          // percent number (e.g. 9)
      maintenance: 1000,
      landTax: 975,
      depreciation: -4500,
      taxRate: 0.37,
      capGrowth: 0.07,
      rentGrowth: 0.06,
      lmi: 0,
      stampDuty: 33320,
    };

    const STORAGE_KEY = "cf_calc_v2"; 
    const KEY_YEARS = new Set([1,5,10,15,20]);

    // --- LMI (Approx AU) ---
    const LMI_PREMIUM_DUTY = {
      "NSW": 0.00,"VIC": 0.10,"QLD": 0.09,"SA":  0.11,"WA":  0.10,"ACT": 0.00,"NT":  0.10,"TAS": 0.10,
    };

    const LOAN_BANDS = [
      [0, 300000, "UP_TO_300K"],
      [300000.01, 500000, "300_500"],
      [500000.01, 600000, "500_600"],
      [600000.01, 750000, "600_750"],
      [750000.01, 1000000, "750_1M"],
    ];

    const LMI_RATE_TABLE = [
      { lo: 80.01, hi: 81.00, rates: {"UP_TO_300K": 0.00475, "300_500": 0.00568, "500_600": 0.00904, "600_750": 0.00904, "750_1M": 0.00913} },
      { lo: 81.01, hi: 82.00, rates: {"UP_TO_300K": 0.00485, "300_500": 0.00568, "500_600": 0.00904, "600_750": 0.00904, "750_1M": 0.00913} },
      { lo: 82.01, hi: 83.00, rates: {"UP_TO_300K": 0.00596, "300_500": 0.00699, "500_600": 0.00932, "600_750": 0.01090, "750_1M": 0.01109} },
      { lo: 83.01, hi: 84.00, rates: {"UP_TO_300K": 0.00662, "300_500": 0.00829, "500_600": 0.00960, "600_750": 0.01090, "750_1M": 0.01146} },
      { lo: 84.01, hi: 85.00, rates: {"UP_TO_300K": 0.00727, "300_500": 0.00969, "500_600": 0.01165, "600_750": 0.01333, "750_1M": 0.01407} },
      { lo: 85.01, hi: 86.00, rates: {"UP_TO_300K": 0.00876, "300_500": 0.01081, "500_600": 0.01258, "600_750": 0.01407, "750_1M": 0.01463} },
      { lo: 86.01, hi: 87.00, rates: {"UP_TO_300K": 0.00932, "300_500": 0.01146, "500_600": 0.01407, "600_750": 0.01631, "750_1M": 0.01733} },
      { lo: 87.01, hi: 88.00, rates: {"UP_TO_300K": 0.01062, "300_500": 0.01305, "500_600": 0.01463, "600_750": 0.01631, "750_1M": 0.01752} },
      { lo: 88.01, hi: 89.00, rates: {"UP_TO_300K": 0.01295, "300_500": 0.01621, "500_600": 0.01948, "600_750": 0.02218, "750_1M": 0.02395} },
      { lo: 89.01, hi: 90.00, rates: {"UP_TO_300K": 0.01463, "300_500": 0.01873, "500_600": 0.02180, "600_750": 0.02367, "750_1M": 0.02516} },
      { lo: 90.01, hi: 91.00, rates: {"UP_TO_300K": 0.02013, "300_500": 0.02618, "500_600": 0.03513, "600_750": 0.03783, "750_1M": 0.03820} },
      { lo: 91.01, hi: 92.00, rates: {"UP_TO_300K": 0.02013, "300_500": 0.02674, "500_600": 0.03569, "600_750": 0.03867, "750_1M": 0.03932} },
      { lo: 92.01, hi: 93.00, rates: {"UP_TO_300K": 0.02330, "300_500": 0.03028, "500_600": 0.03802, "600_750": 0.04081, "750_1M": 0.04156} },
      { lo: 93.01, hi: 94.00, rates: {"UP_TO_300K": 0.02376, "300_500": 0.03028, "500_600": 0.03802, "600_750": 0.04286, "750_1M": 0.04324} },
      { lo: 94.01, hi: 95.00, rates: {"UP_TO_300K": 0.02609, "300_500": 0.03345, "500_600": 0.03998, "600_750": 0.04613, "750_1M": 0.04603} },
    ];

    function pickLoanBandKey(loanAmount) {
      for (const [lo, hi, key] of LOAN_BANDS) {
        if (loanAmount >= lo && loanAmount <= hi) return key;
      }
      if (loanAmount > 1000000) return "750_1M";
      return "UP_TO_300K";
    }

    function findLvrRates(lvrPct) {
      for (const row of LMI_RATE_TABLE) {
        if (lvrPct >= row.lo && lvrPct <= row.hi) return row.rates;
      }
      return null;
    }

    function calcLmiApprox(propertyValue, loanAmount, stateCode) {
      if (!propertyValue || propertyValue <= 0 || !loanAmount || loanAmount <= 0) return 0;
      const lvrPct = (loanAmount / propertyValue) * 100.0;
      if (lvrPct <= 80.0) return 0;
      if (lvrPct > 95.0) return null;

      const rates = findLvrRates(lvrPct);
      if (!rates) return 0;

      const loanBandKey = pickLoanBandKey(loanAmount);
      const rate = rates[loanBandKey];
      if (!rate) return 0;

      const premium = rate * loanAmount;
      const dutyRate = LMI_PREMIUM_DUTY[(stateCode || "").toUpperCase()] ?? 0.0;
      const duty = premium * dutyRate;
      return premium + duty;
    }

    // --- Stamp duty ---
    function calcFromScale(price, scale) {
      if (price < 0) return 0;
      for (const b of scale) {
        if (b.upper === null || price <= b.upper) {
          return b.base + b.rate * (price - b.lower);
        }
      }
      return 0;
    }

    function dutyNSW(price) {
      const scale = [
        {upper: 14000, base:0.0, rate:0.0125, lower:0},
        {upper: 30000, base:175.0, rate:0.0150, lower:14000},
        {upper: 80000, base:415.0, rate:0.0175, lower:30000},
        {upper: 300000, base:1290.0, rate:0.0350, lower:80000},
        {upper: 1000000, base:8990.0, rate:0.0450, lower:300000},
        {upper: 3721000, base:40490.0, rate:0.0550, lower:1000000},
        {upper: null, base:186667.0, rate:0.0700, lower:3721000},
      ];
      return calcFromScale(price, scale);
    }

    function dutyVIC(price) {
      if (price > 960000 && price <= 2000000) return 0.055 * price;
      const scale = [
        {upper: 25000, base:0.0, rate:0.0140, lower:0},
        {upper: 130000, base:350.0, rate:0.0240, lower:25000},
        {upper: 960000, base:2870.0, rate:0.0600, lower:130000},
        {upper: 2000000, base:0.0, rate:0.0550, lower:0},
        {upper: null, base:110000.0, rate:0.0650, lower:2000000},
      ];
      return calcFromScale(price, scale);
    }

    function dutyQLD(price, purpose) {
      if ((purpose || "investment") === "home") {
        const scale = [
          {upper: 350000, base:0.0, rate:0.0100, lower:0},
          {upper: 540000, base:3500.0, rate:0.0350, lower:350000},
          {upper: 1000000, base:10150.0, rate:0.0450, lower:540000},
          {upper: null, base:30850.0, rate:0.0575, lower:1000000},
        ];
        return calcFromScale(price, scale);
      }
      const scale = [
        {upper: 5000, base:0.0, rate:0.0, lower:0},
        {upper: 75000, base:0.0, rate:0.0150, lower:5000},
        {upper: 540000, base:1050.0, rate:0.0350, lower:75000},
        {upper: 1000000, base:17325.0, rate:0.0450, lower:540000},
        {upper: null, base:38225.0, rate:0.0575, lower:1000000},
      ];
      return calcFromScale(price, scale);
    }

    function dutySA(price) {
      const scale = [
        {upper: 12000, base:0.0, rate:0.0100, lower:0},
        {upper: 30000, base:120.0, rate:0.0200, lower:12000},
        {upper: 50000, base:480.0, rate:0.0300, lower:30000},
        {upper: 100000, base:1080.0, rate:0.0350, lower:50000},
        {upper: 200000, base:2830.0, rate:0.0400, lower:100000},
        {upper: 250000, base:6830.0, rate:0.0425, lower:200000},
        {upper: 300000, base:8955.0, rate:0.0475, lower:250000},
        {upper: 500000, base:11330.0, rate:0.0500, lower:300000},
        {upper: null, base:21330.0, rate:0.0550, lower:500000},
      ];
      return calcFromScale(price, scale);
    }

    function dutyWA(price) {
      const scale = [
        {upper: 120000, base:0.0, rate:0.0190, lower:0},
        {upper: 150000, base:2280.0, rate:0.0285, lower:120000},
        {upper: 360000, base:3135.0, rate:0.0380, lower:150000},
        {upper: 725000, base:11115.0, rate:0.0475, lower:360000},
        {upper: null, base:28453.0, rate:0.0515, lower:725000},
      ];
      return calcFromScale(price, scale);
    }

    function dutyTAS(price) {
      const scale = [
        {upper: 3000, base:50.0, rate:0.0, lower:0},
        {upper: 25000, base:50.0, rate:0.0175, lower:3000},
        {upper: 75000, base:435.0, rate:0.0225, lower:25000},
        {upper: 200000, base:1560.0, rate:0.0350, lower:75000},
        {upper: 375000, base:5935.0, rate:0.0400, lower:200000},
        {upper: 725000, base:12935.0, rate:0.0425, lower:375000},
        {upper: null, base:27810.0, rate:0.0450, lower:725000},
      ];
      return calcFromScale(price, scale);
    }

    function dutyACT(price, purpose) {
      purpose = (purpose || "investment");
      if (purpose === "home") {
        if (price > 1455000) return 0.0454 * price;
        const scale = [
          {upper: 260000, base:0.0, rate:0.0060, lower:0},
          {upper: 300000, base:1560.0, rate:0.0220, lower:260000},
          {upper: 500000, base:2440.0, rate:0.0340, lower:300000},
          {upper: 750000, base:9240.0, rate:0.0432, lower:500000},
          {upper: 1000000, base:20040.0, rate:0.0590, lower:750000},
          {upper: 1455000, base:34790.0, rate:0.0640, lower:1000000},
          {upper: null, base:0.0, rate:0.0454, lower:0},
        ];
        return calcFromScale(price, scale);
      }
      if (price > 1455000) return 0.0454 * price;
      const scale = [
        {upper: 200000, base:0.0, rate:0.0120, lower:0},
        {upper: 300000, base:2400.0, rate:0.0220, lower:200000},
        {upper: 500000, base:4600.0, rate:0.0340, lower:300000},
        {upper: 750000, base:11400.0, rate:0.0432, lower:500000},
        {upper: 1000000, base:22200.0, rate:0.0590, lower:750000},
        {upper: 1455000, base:36950.0, rate:0.0640, lower:1000000},
        {upper: null, base:0.0, rate:0.0454, lower:0},
      ];
      return calcFromScale(price, scale);
    }

    function dutyNT(price) {
      if (price <= 525000) {
        const V = price / 1000.0;
        const D = (0.06571441 * (V ** 2)) + (15.0 * V);
        return D;
      }
      if (price < 3000000) return 0.0495 * price;
      if (price < 5000000) return 0.0575 * price;
      return 0.0595 * price;
    }

    function calcDuty(stateCode, price, purpose) {
      const st = (stateCode || "").toUpperCase().trim();
      if (!st || !price || price <= 0) return 0;
      if (st === "NSW") return dutyNSW(price);
      if (st === "VIC") return dutyVIC(price);
      if (st === "QLD") return dutyQLD(price, purpose);
      if (st === "SA") return dutySA(price);
      if (st === "WA") return dutyWA(price);
      if (st === "TAS") return dutyTAS(price);
      if (st === "ACT") return dutyACT(price, purpose);
      if (st === "NT") return dutyNT(price);
      return 0;
    }

    function clamp(n, min, max) { return Math.min(Math.max(n, min), max); }

    function toNumberLoose(input) {
      if (input == null) return 0;
      let s = String(input).trim();
      if (!s) return 0;
      s = s.replace(/[\\s,$]/g, "");
      const last = s.slice(-1).toLowerCase();
      if (last === "k" || last === "m") {
        const base = parseFloat(s.slice(0, -1));
        if (Number.isFinite(base)) return last === "k" ? base * 1000 : base * 1000000;
      }
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }

    function parsePercent(input, fallback=0) {
      if (input == null) return fallback;
      let s = String(input).trim();
      if (!s) return fallback;
      s = s.replace(/[%\\s]/g, "");
      const n = parseFloat(s);
      if (!Number.isFinite(n)) return fallback;
      return n / 100;
    }

    function fmtMoney(n) {
      const x = Number.isFinite(n) ? n : 0;
      return x.toLocaleString("en-AU", { style:"currency", currency:"AUD", maximumFractionDigits:0 });
    }

    function fmtPercent(n, decimals=2) {
      const x = Number.isFinite(n) ? n : 0;
      return (x * 100).toFixed(decimals) + "%";
    }

    function normalizeState() {
      const el = $("state");
      const raw = (el.value || "").trim();
      if (!raw) return;
      const key = raw.toUpperCase();
      if (STATE_MAP.has(key)) { el.value = STATE_MAP.get(key); return; }
      const cleaned = key.replace(/\\(.*?\\)/g, "").trim();
      if (STATE_MAP.has(cleaned)) el.value = STATE_MAP.get(cleaned);
    }

    function forceNegative(id) {
      const el = $(id);
      let val = toNumberLoose(el.value);
      if (val > 0) val = -val;
      el.value = fmtMoney(val);
    }

    const themeToggle = $("themeToggle");
    function setTheme(mode) {
      document.body.setAttribute("data-theme", mode);
      try { localStorage.setItem("cf_theme", mode); } catch(e) {}
    }
    function toggleTheme() {
      const cur = document.body.getAttribute("data-theme") || "light";
      setTheme(cur === "light" ? "dark" : "light");
    }
    themeToggle.addEventListener("click", toggleTheme, { passive:true });

    function updateLmiModeTag() {
      const on = $("lmiAuto").checked;
      $("lmiModeTag").textContent = on ? "Auto" : "Manual";
      $("lmi").disabled = on;
    }

    function updateDutyModeTag() {
      const on = $("dutyAuto").checked;
      $("dutyModeTag").textContent = on ? "Auto" : "Manual";
      $("stampDuty").disabled = on;
    }

    function updatePmModeTag() {
      const on = $("pmUseFormula").checked;
      $("pmModeTag").textContent = on ? "Auto" : "Manual";
      $("pmFee").disabled = on;

      const pmPct = clamp(parsePercent($("pmFeePct").value, (DEFAULTS.pmPct / 100.0)), 0, 1);
      const pctText = Math.round(pmPct * 100);
      $("pmFee").setAttribute("placeholder", `auto = Rental income (Yr) × ${pctText}%`);
    }

    $("pmUseFormula").addEventListener("change", () => { updatePmModeTag(); safeRecalc(); });
    $("lmiAuto").addEventListener("change", () => { updateLmiModeTag(); safeRecalc(); });
    $("dutyAuto").addEventListener("change", () => { updateDutyModeTag(); safeRecalc(); });

    function getForecastYears(mode) {
      if (mode === "key") return [1,5,10,15,20];
      const years = [];
      for (let y=1; y<=20; y++) years.push(y);
      return years;
    }
    $("forecastMode").addEventListener("change", () => safeRecalc());

    function getCurrentFormState() {
      return {
        address: $("address").value || "",
        purchasePrice: $("purchasePrice").value || "",
        state: $("state").value || "",
        lvr: $("lvr").value || "",
        lmi: $("lmi").value || "",
        lmiAuto: $("lmiAuto").checked,
        stampDuty: $("stampDuty").value || "",
        dutyAuto: $("dutyAuto").checked,
        interest: $("interest").value || "",
        rentWeek: $("rentWeek").value || "",
        councilRates: $("councilRates").value || "",
        insurance: $("insurance").value || "",
        pmFeePct: $("pmFeePct").value || "",
        pmFee: $("pmFee").value || "",
        pmUseFormula: $("pmUseFormula").checked,
        maintenance: $("maintenance").value || "",
        landTax: $("landTax").value || "",
        depreciation: $("depreciation").value || "",
        taxRate: $("taxRate").value || "",
        capGrowth: $("capGrowth").value || "",
        rentGrowth: $("rentGrowth").value || "",
        forecastMode: $("forecastMode").value || "key",
        theme: document.body.getAttribute("data-theme") || "light",
      };
    }

    function setIfNonEmpty(id, val) {
      if (typeof val !== "string") return;
      const trimmed = val.trim();
      if (!trimmed) return;                 // skip empty strings so defaults remain
      $(id).value = trimmed;
    }

    function applyFormState(s) {
      if (!s || typeof s !== "object") return;

      // Allow address to be empty in template mode
      if (typeof s.address === "string") $("address").value = s.address;

      // Price: allow empty in template mode, otherwise skip blank
      if (typeof s.purchasePrice === "string") {
        if (IS_TEMPLATE) $("purchasePrice").value = s.purchasePrice;
        else if (s.purchasePrice.trim()) $("purchasePrice").value = s.purchasePrice.trim();
      }

      // Everything else: do NOT overwrite defaults with ""
      setIfNonEmpty("state", s.state);
      setIfNonEmpty("lvr", s.lvr);

      if (typeof s.lmiAuto === "boolean") $("lmiAuto").checked = s.lmiAuto;
      setIfNonEmpty("lmi", s.lmi);

      if (typeof s.dutyAuto === "boolean") $("dutyAuto").checked = s.dutyAuto;
      setIfNonEmpty("stampDuty", s.stampDuty);

      setIfNonEmpty("interest", s.interest);
      setIfNonEmpty("rentWeek", s.rentWeek);

      setIfNonEmpty("councilRates", s.councilRates);
      setIfNonEmpty("insurance", s.insurance);
      setIfNonEmpty("pmFeePct", s.pmFeePct);
      if (typeof s.pmUseFormula === "boolean") $("pmUseFormula").checked = s.pmUseFormula;
      setIfNonEmpty("pmFee", s.pmFee);

      setIfNonEmpty("maintenance", s.maintenance);
      setIfNonEmpty("landTax", s.landTax);
      setIfNonEmpty("depreciation", s.depreciation);

      setIfNonEmpty("taxRate", s.taxRate);
      setIfNonEmpty("capGrowth", s.capGrowth);
      setIfNonEmpty("rentGrowth", s.rentGrowth);

      if (typeof s.forecastMode === "string" && s.forecastMode.trim()) {
        $("forecastMode").value = s.forecastMode.trim();
      }

      if (typeof s.theme === "string" && (s.theme === "light" || s.theme === "dark")) {
        setTheme(s.theme);
      }
    }


    function saveToBrowserCache() {
      const status = $("saveStatus");
      try {
        const payload = getCurrentFormState();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        status.textContent = "Saved to browser cache.";
      } catch (e) {
        status.textContent = "Save failed (browser blocked storage).";
      }
      setTimeout(() => { status.textContent = ""; }, 2500);
    }

    function resetBrowserCache() {
      const status = $("saveStatus");
      try {
        localStorage.removeItem(STORAGE_KEY);
        status.textContent = "Reset: browser cache cleared.";
      } catch (e) {
        status.textContent = "Reset failed.";
      }
      setTimeout(() => { status.textContent = ""; }, 2500);
    }

    $("saveBtn").addEventListener("click", () => { saveToBrowserCache(); safeRecalc(); });
    $("resetBtn").addEventListener("click", () => { resetBrowserCache(); applyDefaults(); safeRecalc(); });

    function applyDefaults() {
      $("address").value = (DEFAULTS.address || "");
      $("purchasePrice").value = fmtMoney(DEFAULTS.purchase);

      $("state").value = (DEFAULTS.state || "");
      $("lvr").value = fmtPercent(DEFAULTS.lvr, 0);
      $("interest").value = fmtPercent(DEFAULTS.interest, 2);
      $("rentWeek").value = fmtMoney(DEFAULTS.rentWeek);
      $("councilRates").value = fmtMoney(DEFAULTS.council);
      $("insurance").value = DEFAULTS.insurance ? fmtMoney(DEFAULTS.insurance) : "";
      $("maintenance").value = fmtMoney(DEFAULTS.maintenance);
      $("landTax").value = fmtMoney(DEFAULTS.landTax);
      $("depreciation").value = fmtMoney(DEFAULTS.depreciation);
      $("taxRate").value = fmtPercent(DEFAULTS.taxRate, 0);
      $("capGrowth").value = fmtPercent(DEFAULTS.capGrowth, 0);
      $("rentGrowth").value = fmtPercent(DEFAULTS.rentGrowth, 0);

      $("lmi").value = fmtMoney(Number(DEFAULTS.lmi || 0));
      $("stampDuty").value = fmtMoney(Number(DEFAULTS.stampDuty || 0));

      $("pmFeePct").value = fmtPercent((DEFAULTS.pmPct / 100.0), 0);
      $("pmUseFormula").checked = true;
      $("pmFee").setAttribute("placeholder", `auto = Rental income (Yr) × ${DEFAULTS.pmPct}%`);

      $("lmiAuto").checked = true;
      $("dutyAuto").checked = true;

      updateLmiModeTag();
      updateDutyModeTag();
      updatePmModeTag();
    }

    function setPropertyFieldsEditable() {
      const addr = $("address");
      const price = $("purchasePrice");

      if (IS_TEMPLATE) {
        addr.disabled = false;
        price.disabled = false;
        $("templateNote").style.display = "block";
      } else {
        addr.disabled = true;
        price.disabled = true;
        $("templateNote").style.display = "none";
      }
    }

    function recalc() {
      // property inputs
      const address = ($("address").value || "").trim();
      let purchase = toNumberLoose($("purchasePrice").value);
      if (!purchase || purchase <= 0) purchase = DEFAULTS.purchase;

      // keep formatted
      $("purchasePrice").value = fmtMoney(purchase);

      // auto state from Address (whenever address contains a valid ending like "NSW 2440")
      if (address) {
        const m = address.match(/,\s*([A-Za-z]{2,3})\s+\d{3,4}\s*$/) || address.match(/\b([A-Za-z]{2,3})\s+\d{3,4}\s*$/);
        if (m && m[1]) {
          $("state").value = m[1].toUpperCase();
        }
      }
      normalizeState();


      const stateCode = ($("state").value || "").trim().toUpperCase();
      const lvr = clamp(parsePercent($("lvr").value, DEFAULTS.lvr), 0, 1);

      // Auto Duty
      let stampDuty = toNumberLoose($("stampDuty").value);
      if ($("dutyAuto").checked) {
        stampDuty = calcDuty(stateCode, purchase, DUTY_PURPOSE);
        $("stampDuty").value = fmtMoney(stampDuty);
      }

      // Auto LMI
      let lmi = toNumberLoose($("lmi").value);
      const loanForLmi = purchase * lvr;
      if ($("lmiAuto").checked) {
        const out = calcLmiApprox(purchase, loanForLmi, stateCode);
        if (out === null) {
          $("lmi").value = "Not supported >95% LVR";
          lmi = 0;
        } else {
          lmi = out;
          $("lmi").value = fmtMoney(lmi);
        }
      }

      const interest = clamp(parsePercent($("interest").value, DEFAULTS.interest), 0, 1);
      const rentWeek0 = toNumberLoose($("rentWeek").value);

      const council = toNumberLoose($("councilRates").value);
      const insurance = toNumberLoose($("insurance").value);
      const maintenance = toNumberLoose($("maintenance").value);
      const landTax = toNumberLoose($("landTax").value);

      let depreciation = toNumberLoose($("depreciation").value);
      if (depreciation > 0) depreciation = -depreciation;

      const taxRate = clamp(parsePercent($("taxRate").value, DEFAULTS.taxRate), 0, 1);
      const capGrowth = clamp(parsePercent($("capGrowth").value, DEFAULTS.capGrowth), 0, 1);
      const rentGrowth = clamp(parsePercent($("rentGrowth").value, DEFAULTS.rentGrowth), 0, 1);

      const deposit = purchase - (purchase * lvr);
      const totalBuyingExpenses = purchase * 5.5 / 100;
      const totalCostBase = purchase + totalBuyingExpenses;
      const loan = purchase * lvr;

      const repaymentIO = (loan + lmi) * interest;

      const rentYr0 = rentWeek0 * 52;

      const pmPct = clamp(parsePercent($("pmFeePct").value, (DEFAULTS.pmPct / 100.0)), 0, 1);
      const pmUseFormula = $("pmUseFormula").checked;
      const pmFee0 = pmUseFormula ? (rentYr0 * pmPct) : toNumberLoose($("pmFee").value);

      if (pmUseFormula) $("pmFee").value = fmtMoney(pmFee0);

      const runningExpenses0 = council + insurance + pmFee0 + maintenance + landTax;
      const totalExpense0 = runningExpenses0 + repaymentIO;

      const grossYield = purchase > 0 ? (rentYr0 / purchase) : 0;
      const netYield = purchase > 0 ? ((rentYr0 - runningExpenses0) / purchase) : 0;

      const cashflowBeforeTax0 = rentYr0 - totalExpense0;
      const taxable0 = cashflowBeforeTax0 + depreciation;
      const tax0 = taxable0 * taxRate;
      const cashflowAfterTax0 = cashflowBeforeTax0 - tax0;

      const annualCapitalGrowthBase = purchase * capGrowth;

      $("summaryKv").innerHTML = `
        <div class="k">Purchase Price</div><div class="v">${fmtMoney(purchase)}</div>
        <div class="k">LVR</div><div class="v">${fmtPercent(lvr, 0)}</div>
        <div class="k">Deposit</div><div class="v">${fmtMoney(deposit)}</div>
        <div class="k">Loan</div><div class="v">${fmtMoney(loan)}</div>
        <div class="k">Interest</div><div class="v">${fmtPercent(interest, 2)}</div>
        <div class="k">Repayment (IO / Yr)</div><div class="v">${fmtMoney(repaymentIO)}</div>

        <div class="k">LMI</div><div class="v">${($("lmi").value.includes("Not supported") ? $("lmi").value : fmtMoney(lmi))}</div>
        <div class="k">Stamp duty</div><div class="v">${fmtMoney(stampDuty)}</div>
        <div class="k">Buying exp (5.5%)</div><div class="v">${fmtMoney(totalBuyingExpenses)}</div>
        <div class="k">Total cost base</div><div class="v">${fmtMoney(totalCostBase)}</div>
      `;

      // Added fields in relevant area (expenses/yield block)
      $("yieldKv").innerHTML = `
        <div class="k">Rent/week</div><div class="v">${fmtMoney(rentWeek0)}</div>
        <div class="k">Rent (Yr)</div><div class="v">${fmtMoney(rentYr0)}</div>

        <div class="k">Council Rates</div><div class="v">${fmtMoney(council)}</div>
        <div class="k">Insurance</div><div class="v">${fmtMoney(insurance)}</div>
        <div class="k">Property Management fees</div><div class="v">${fmtMoney(pmFee0)}</div>
        <div class="k">Maintenance</div><div class="v">${fmtMoney(maintenance)}</div>
        <div class="k">Land Tax</div><div class="v">${fmtMoney(landTax)}</div>

        <div class="k">Running Exp</div><div class="v">${fmtMoney(runningExpenses0)}</div>
        <div class="k">Total Exp</div><div class="v">${fmtMoney(totalExpense0)}</div>

        <div class="k">Gross yield</div><div class="v">${fmtPercent(grossYield, 2)}</div>
        <div class="k">Net yield</div><div class="v">${fmtPercent(netYield, 2)}</div>
      `;

      const cfClass = cashflowAfterTax0 >= 0 ? "good" : "bad";
      $("cashflowKv").innerHTML = `
        <div class="k">Cashflow Before tax</div><div class="v ${cashflowBeforeTax0>=0 ? "good":"bad"}">${fmtMoney(cashflowBeforeTax0)}</div>
        <div class="k">Depreciation</div><div class="v">${fmtMoney(depreciation)}</div>
        <div class="k">Taxable</div><div class="v">${fmtMoney(taxable0)}</div>
        <div class="k">Tax rate</div><div class="v">${fmtPercent(taxRate, 0)}</div>
        <div class="k">Tax</div><div class="v">${fmtMoney(tax0)}</div>
        <div class="k"><b>Cashflow after tax</b></div><div class="v ${cfClass}"><b>${fmtMoney(cashflowAfterTax0)}</b></div>
        <div class="k">Cap growth (Yr1 base)</div><div class="v">${fmtMoney(annualCapitalGrowthBase)}</div>
      `;

      // Forecast: Year 1 = current year (no growth applied)
      const mode = $("forecastMode").value;
      const yearsToShow = getForecastYears(mode);

      let body = "";
      let propValue = purchase;
      let accCap = 0;

      for (let y = 1; y <= 20; y++) {
        const exponent = (y - 1);

        const rentWeekY = rentWeek0 * Math.pow(1 + rentGrowth, exponent);
        const rentYrY = rentWeekY * 52;

        const pmFeeY = pmUseFormula ? (rentYrY * pmPct) : pmFee0;

        const runningY = council + insurance + pmFeeY + maintenance + landTax;
        const totalExpY = runningY + repaymentIO;

        const cfBeforeY = rentYrY - totalExpY;
        const taxableY = cfBeforeY + depreciation;
        const taxY = taxableY * taxRate;
        const cfAfterY = cfBeforeY - taxY;

        const annualCapGrowthY = propValue * capGrowth;
        accCap += annualCapGrowthY;

        if (yearsToShow.includes(y)) {
          const rowClass = (mode === "all" && KEY_YEARS.has(y)) ? "keyyear" : "";
          body += `
            <tr class="${rowClass}">
              <td class="num">${y}</td>
              <td class="num">${fmtMoney(rentYrY)}</td>
              <td class="num" style="font-weight:950; color:${cfAfterY>=0 ? "var(--ok)" : "var(--danger)"}">
                ${fmtMoney(cfAfterY)}
              </td>
              <td class="num">${fmtMoney(propValue)}</td>
              <td class="num">${fmtMoney(annualCapGrowthY)}</td>
              <td class="num">${fmtMoney(accCap)}</td>
            </tr>
          `;
        }

        propValue = propValue + annualCapGrowthY;
      }
      $("forecastBody").innerHTML = body;

      $("lvr").value = fmtPercent(lvr, 0);
      $("interest").value = fmtPercent(interest, 2);
      $("taxRate").value = fmtPercent(taxRate, 0);
      $("capGrowth").value = fmtPercent(capGrowth, 0);
      $("rentGrowth").value = fmtPercent(rentGrowth, 0);

      updatePmModeTag();
      updateLmiModeTag();
      updateDutyModeTag();
    }

    function safeRecalc() {
      try {
        const box = $("errorBox");
        box.textContent = "";
        box.classList.remove("show");
        recalc();
      } catch (e) {
        const box = $("errorBox");
        const msg = (e && (e.stack || e.message)) ? (e.stack || e.message) : String(e);
        box.textContent = "JavaScript error:\\n" + msg;
        box.classList.add("show");
      }
    }

    $("recalcBtn").addEventListener("click", safeRecalc);
    $("state").addEventListener("blur", () => { normalizeState(); safeRecalc(); });
    $("depreciation").addEventListener("blur", () => { forceNegative("depreciation"); safeRecalc(); });

    // Recalc on address/price changes too (template mode)
    $("address").addEventListener("blur", () => safeRecalc());
    $("purchasePrice").addEventListener("blur", () => safeRecalc());

    let t = null;
    function debounceRecalc() {
      if (t) clearTimeout(t);
      t = setTimeout(() => safeRecalc(), 250);
    }

    [
      "address","purchasePrice",
      "rentWeek","capGrowth","rentGrowth","interest","taxRate",
      "councilRates","insurance","maintenance","landTax",
      "lmi","stampDuty","pmFeePct","pmFee","lvr","state"
    ].forEach(id => $(id).addEventListener("input", debounceRecalc));

    function initRun() {
      try {
        const savedTheme = localStorage.getItem("cf_theme");
        if (savedTheme === "dark" || savedTheme === "light") setTheme(savedTheme);
      } catch(e) {}

      setPropertyFieldsEditable();
      applyDefaults();

      // load saved values (browser cache only)
      // IMPORTANT: In non-template mode, do NOT let saved cache override address/price from the generated HTML
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const obj = JSON.parse(raw);

          if (!IS_TEMPLATE) {
            // Keep injected address/price fixed (locked)
            if (obj && typeof obj === "object") {
              delete obj.address;
              delete obj.purchasePrice;
            }
          }

          applyFormState(obj);
        }
      } catch(e) {}

      // forecast mode default: key on mobile
      if (!($("forecastMode").value || "").trim()) {
        $("forecastMode").value = (window.matchMedia("(max-width: 560px)").matches ? "key" : "all");
      }

      updatePmModeTag();
      updateLmiModeTag();
      updateDutyModeTag();
      safeRecalc();
    }

    document.addEventListener("DOMContentLoaded", initRun);
    window.addEventListener("load", initRun);
    setTimeout(initRun, 150);
    setTimeout(initRun, 600);
  </script>
</body>
</html>
